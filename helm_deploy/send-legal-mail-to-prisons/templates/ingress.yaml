apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: check-rule39-mail
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
  {{- if .Values.allowlist }}
    nginx.ingress.kubernetes.io/whitelist-source-range: {{ include "app.joinListWithComma" .Values.allowlist | quote }}
  {{- end }}
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/custom-http-errors: "418"
    external-dns.alpha.kubernetes.io/aws-weight: "100"
    external-dns.alpha.kubernetes.io/set-identifier: {{ .Values.ingress.internalSetIdentifier }}
    nginx.ingress.kubernetes.io/limit-rpm: "60"
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header X-Robots-Tag "noindex, nofollow";
      limit_req_status 429;
spec:
  tls:
  - hosts:
    - {{ .Values.ingress.internalHost }}
    secretName: {{ .Values.ingress.internalCertSecret }}
  rules:
  - host: {{ .Values.ingress.internalHost }}
    http:
      paths:
        - path: /
          backend:
            serviceName: send-legal-mail-to-prisons
            servicePort: http
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: send-legal-mail-to-prisons
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
  {{- if .Values.allowlist }}
    nginx.ingress.kubernetes.io/whitelist-source-range: {{ include "app.joinListWithComma" .Values.allowlist | quote }}
  {{- end }}
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/custom-http-errors: "418"
    external-dns.alpha.kubernetes.io/aws-weight: "100"
    external-dns.alpha.kubernetes.io/set-identifier: {{ .Values.ingress.externalSetIdentifier }}
    nginx.ingress.kubernetes.io/configuration-snippet: |
      location = / {
        return 301 $scheme://$host/barcode/find-recipient;
      }
    nginx.ingress.kubernetes.io/limit-rpm: "60"
    nginx.ingress.kubernetes.io/server-snippet: |
      add_header X-Robots-Tag "noindex, nofollow";
      limit_req_status 429;
spec:
  tls:
    - hosts:
      - {{ .Values.ingress.externalHost }}
      secretName: {{ .Values.ingress.externalCertSecret }}
  rules:
    - host: {{ .Values.ingress.externalHost }}
      http:
        paths:
            - path: /
              backend:
                serviceName: send-legal-mail-to-prisons
                servicePort: http
