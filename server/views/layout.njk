{% extends "govuk/template.njk" %}
{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}

{% block head %}
  <script nonce="{{ cspNonce }}" data-qa="gtm-init">
    // Define dataLayer and the gtag function.
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}

    {% if externalUser %}
      window.dataLayer.push({
          'user': {
            'organisation': '{{ barcodeUser.cjsmDetails.organisation }}',
            'business_type': '{{ barcodeUser.cjsmDetails.organisationType }}',
            'town_city': '{{ barcodeUser.cjsmDetails.townOrCity }}',
          },
        });
    {% endif %}

    {% if not externalUser %}
      window.dataLayer.push({
          'user': {
            'prison_code': '{{ user.activeCaseLoadId }}',
            'prison_name': '{{ user.prisonName }}',
          },
        });
    {% endif %}

    // Default analytics_storage to 'denied'.
    gtag('consent', 'default', {
      'analytics_storage': 'denied'
    });
  </script>

  {# Update analytics_storage to 'granted' if the user has accepted analytics cookies #}
  {% if gtmContainerId and (cookiesPolicy.policy === 'accept' or cookiesPolicy.policy === 'n/a') %}
    <script nonce="{{ cspNonce }}">
    gtag('consent', 'update', {
      'analytics_storage': 'granted'
    });
    </script>
  {% endif %}

  {% if gtmContainerId != null %}
  {# Google Tag Manager #}
  <script nonce="{{ cspNonce }}" data-qa="gtm">
    ;
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer'
          ? '&l=' + l
          : '';
      j.async = true;
      j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      var n = d.querySelector('[nonce]');
      n && j.setAttribute('nonce', n.nonce || n.getAttribute('nonce'));
      f
        .parentNode
        .insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', '{{ gtmContainerId }}');
  </script>
  {# End Google Tag Manager #}
  {% endif %}

  <!--[if !IE 8]><!-->
  <link href="/assets/stylesheets/application.css?{{ version }}" rel="stylesheet"/>
  <!--<![endif]-->

  <!--[if lt IE 9]>
  <link href="/assets/stylesheets/application-ie8.css?{{ version }}" rel="stylesheet"/>
  <script src="/assets/js/html5shiv-3.7.3.min.js" nonce="{{ cspNonce }}"></script>
  <![endif]-->

  <script src="/assets/js/jquery.min.js" nonce="{{ cspNonce }}"></script>

  <script src="/assets/js/jquery.inputmask.js" nonce="{{ cspNonce }}"></script>
  <script src="/assets/js/inputmask.binding.js" nonce="{{ cspNonce }}"></script>

  <script src="/assets/js/accessible-autocomplete.min.js" nonce="{{ cspNonce }}"></script>
  <link href="/assets/stylesheets/accessible-autocomplete.min.css" rel="stylesheet"/>

  <script src="/assets/js/page-enhancements.js" nonce="{{ cspNonce }}"></script>

{% endblock %}

{% block pageTitle %}{{pageTitle | default(applicationName)}}{% endblock %}

{% block header %}
  {% include "partials/cookies/cookie-banner.njk" %}
  {% include "partials/header.njk" %}
{% endblock %}

{% block bodyStart %}
  {% if gtmContainerId %}
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe src="https://www.googletagmanager.com/ns.html?id={{gtmContainerId}}" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
  {% endif %}
{% endblock %}

{# Override the `main` block from the govuk template so that we can add the Contact The Helpdesk banner #}
{% block main %}
  <div class="govuk-width-container {{ containerClasses }}">

    {{ govukPhaseBanner({
      attributes: {
        role: "complementary"
      },
      tag: {
        text: "beta"
      },
      html: 'Leave <a class="govuk-link" rel="noreferrer noopener" target="_blank" href="'+ phaseBannerLink +'">feedback<span class="govuk-visually-hidden"> (opens in new tab)</span></a> to help us improve this new service.'
    }) }}

    {# The following pageId element is deprecated. Tests should target the new element with id `pageId` to assert the value via the `data-qa` attribute instead #}
    <span class="govuk-visually-hidden" id="{{ pageId }}"></span>
    <span class="govuk-visually-hidden" id="pageId" data-qa="{{ pageId }}"></span>

    <main class="govuk-main-wrapper {{ mainClasses }}" id="main-content" role="main"{% if mainLang %} lang="{{ mainLang }}"{% endif %}>
      {% block content %}{% endblock %}
    </main>

    {% if pageId not in contactHelpdeskBannerExcludedOnPages %}
      <section class="contact-helpdesk" role="complementary">
        {% set contactHelpdeskUrl %}
          {% if externalUser %}
            /contact-helpdesk?pageId={{ pageId }}
          {% else %}
            /scan-barcode/contact-helpdesk?pageId={{ pageId }}
          {% endif %}
        {% endset %}
        <a href="{{ contactHelpdeskUrl }}" target="_blank" class="govuk-link govuk-link--inverse" data-qa="contact-helpdesk">Contact helpdesk (opens in new tab)</a>
      </section>
    {% endif %}

  </div>
{% endblock %}

{% block footer %}
  {%- from "govuk/components/footer/macro.njk" import govukFooter -%}
  {% set footerItems = [{ href: "/cookies-policy", text: "Cookies" }] %}
  {% if externalUser %}
    {% set footerItems = (footerItems.unshift({ href: "/privacy-policy", text: "Privacy policy" }), footerItems) %}
  {% endif %}

  {{ govukFooter({
    meta: {
      items: footerItems
    }
  }) }}
{% endblock %}

{% block bodyEnd %}
  {# Run JavaScript at end of the
  <body>, to avoid blocking the initial render. #}
  <script src="/assets/govuk/all.js" nonce="{{ cspNonce }}"></script>
  <script src="/assets/moj/all.js" nonce="{{ cspNonce }}"></script>
  <script src="/assets/govukFrontendInit.js" nonce="{{ cspNonce }}"></script>
  <script src="/assets/mojFrontendInit.js" nonce="{{ cspNonce }}"></script>
  {% block pageScripts %}{% endblock %}
{% endblock %}
