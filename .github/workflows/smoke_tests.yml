name: Smoke tests
on:
  workflow_call:
    inputs:
      environment:
        description: Environment
        type: string
        required: false
        default: 'dev'
      node_version_file:
        description: "Passed to setup-node action to specify where to source the version of node from"
        required: false
        type: string
        default: ".nvmrc"
permissions:
  contents: read
jobs:
  smoke_test:
    name: Run the node build 
    runs-on: cypress/included:14.5.0
    # defaults.run.working-directory: ./scripts
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ inputs.node_version_file }}
        uses: actions/setup-node@v4
        with:
          node-version-file: ${{ inputs.node_version_file }}
      - name: update npm
        shell: bash
        run: |
          sudo npm install -g npm@latest
      - name: install dependencies
        shell: bash
        run: |
          npm ci --no-audit
      - name: save cache
        id: save-cache
        uses: actions/cache/save@v4
        env: 
          cache-name: node-modules
        with:
          path: |
            ./node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json', '!**/node_modules/**') }}
      - name: build npm
        shell: bash
        run: |
          npm run build
      - name: Linter check # Run linter after build because the integration test code depend on compiled typescript...
        shell: bash
        run: | 
          npm run lint
      - name: Update credentials
        run: wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | tee /etc/apt/trusted.gpg.d/google.asc >/dev/null
      - name: Install curl
        run: apt-get update && apt-get install -y curl
      - name: Authenticate
        uses: ministryofjustice/hmpps-github-actions/.github/actions/build-test-and-deploy/cloud-platform-auth@v2 # WORKFLOW_VERSION
        with:
          api: https://${{ secrets.KUBE_CLUSTER }}
          cert: ${{ secrets.cert }}
          cluster: ${{ secrets.cluster }}
          namespace: ${{ secrets.namespace }}
          token: ${{ secrets.token }}
      - name: Install jq
        run: apt-get update && apt-get install -y jq
      - name: Run smoke tests in ${{ inputs.environment }}
        run: |
          cd smoke_tests
          ./run-smoke-test.sh \
            --env ${{ inputs.environment }} \
            --lsj-secret $(kubectl -n send-legal-mail-to-prisons${{ inputs.environment }} get secret smoke-test --template=${{ secrets.APP_SMOKETEST_LSJSECRET }} | base64 -d) \
            --msj-secret $(kubectl -n send-legal-mail-to-prisons${{ inputs.environment }} get secret smoke-test --template=${{ secrets.APP_SMOKETEST_MSJSECRET }} | base64 -d) \
            --lsj-url https://send-legal-mail-${{ inputs.environment }}.prison.service.justice.gov.uk \
            --msj-url https://check-rule39-mail-${{ inputs.environment }}.prison.service.justice.gov.uk \
            --cypress-exe cypress
